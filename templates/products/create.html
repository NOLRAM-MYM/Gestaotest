{% extends "base.html" %}
{% block title %}Novo Produto{% endblock %}
{% block content %}
<div class="container">
    <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0">Novo Produto</h4>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control") }}
                            {% if form.name.errors %}
                                {% for error in form.name.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", rows=3) }}
                            {% if form.description.errors %}
                                {% for error in form.description.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.data_entrada.label(class="form-label") }}
                                {{ form.data_entrada(class="form-control") }}
                                {% if form.data_entrada.errors %}
                                    {% for error in form.data_entrada.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ form.stock.label(class="form-label") }}
                                {{ form.stock(class="form-control") }}
                                {% if form.stock.errors %}
                                    {% for error in form.stock.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.category.label(class="form-label") }}
                                {{ form.category(class="form-select") }}
                                {% if form.category.errors %}
                                    {% for error in form.category.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ form.price.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    {{ form.price(class="form-control") }}
                                </div>
                                {% if form.price.errors %}
                                    {% for error in form.price.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.custo1.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    {{ form.custo1(class="form-control custo-input") }}
                                </div>
                                {% if form.custo1.errors %}
                                    {% for error in form.custo1.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ form.custo2.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    {{ form.custo2(class="form-control custo-input") }}
                                </div>
                                {% if form.custo2.errors %}
                                    {% for error in form.custo2.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.custo3.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    {{ form.custo3(class="form-control custo-input") }}
                                </div>
                                {% if form.custo3.errors %}
                                    {% for error in form.custo3.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ form.custo4.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    {{ form.custo4(class="form-control custo-input") }}
                                </div>
                                {% if form.custo4.errors %}
                                    {% for error in form.custo4.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.custo5.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    {{ form.custo5(class="form-control custo-input") }}
                                </div>
                                {% if form.custo5.errors %}
                                    {% for error in form.custo5.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="total_custos" class="form-label">Total dos Custos</label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="text" class="form-control" id="total_custos" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Imagens do Produto (Máximo 5)</label>
                            <div class="dropzone-container" id="dropzone">
                                <div class="dropzone-area">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                    <p>Arraste e solte as imagens aqui ou clique para selecionar</p>
                                    <input type="file" class="form-control d-none" name="images[]" id="fileInput" accept="image/*" multiple>
                                </div>
                                <div id="preview-container" class="image-preview-container"></div>
                            </div>
                            <div class="form-text">Formatos aceitos: PNG, JPG, JPEG, GIF. Selecione até 5 imagens.</div>
                        </div>
                        <style>
                            .dropzone-container {
                                border: 2px dashed #ccc;
                                border-radius: 4px;
                                padding: 20px;
                                text-align: center;
                                background-color: #f8f9fa;
                                transition: all 0.3s ease;
                            }
                            .dropzone-container.dragover {
                                background-color: #e9ecef;
                                border-color: #0d6efd;
                            }
                            .dropzone-area {
                                cursor: pointer;
                            }
                            .image-preview-container {
                                display: flex;
                                flex-wrap: wrap;
                                gap: 10px;
                                margin-top: 15px;
                            }
                            .image-preview {
                                position: relative;
                                width: 150px;
                                height: 150px;
                            }
                            .image-preview img {
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                                border-radius: 4px;
                            }
                            .image-preview .remove-image {
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                background-color: rgba(255, 0, 0, 0.7);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 24px;
                                height: 24px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                            .image-preview .remove-image:hover {
                                background-color: rgba(255, 0, 0, 0.9);
                            }
                        </style>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Salvar Produto</button>
                            <a href="{{ url_for('products.list_products') }}" class="btn btn-outline-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const previewContainer = document.getElementById('preview-container');
let files = [];

dropzone.addEventListener('click', () => fileInput.click());

dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('dragover');
});

dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('dragover');
});

dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    const newFiles = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
    handleFiles(newFiles);
});

fileInput.addEventListener('change', (e) => {
    const newFiles = Array.from(e.target.files);
    handleFiles(newFiles);
});

function handleFiles(newFiles) {
    if (files.length + newFiles.length > 5) {
        alert('Você pode selecionar no máximo 5 imagens.');
        return;
    }

    newFiles.forEach(file => {
        if (!file.type.startsWith('image/')) {
            alert('Por favor, selecione apenas arquivos de imagem.');
            return;
        }

        files.push(file);
        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            preview.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button type="button" class="remove-image" data-filename="${file.name}">&times;</button>
            `;
            previewContainer.appendChild(preview);

            preview.querySelector('.remove-image').addEventListener('click', function() {
                const filename = this.dataset.filename;
                files = files.filter(f => f.name !== filename);
                preview.remove();
                updateFileInput();
            });
        };
        reader.readAsDataURL(file);
    });

    updateFileInput();
}

function updateFileInput() {
    const dataTransfer = new DataTransfer();
    files.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;
}

function formatNumber(number) {
    // Arredonda para 0 casas decimais
    const roundedValue = Math.round(number);
    return new Intl.NumberFormat('ja-JP', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(roundedValue);
}

const priceInput = document.getElementById('price');
priceInput.addEventListener('input', function(e) {
    if (e.target.value < 0) e.target.value = 0;
    const value = e.target.value;
    if (value) {
        const formattedValue = formatNumber(value);
        e.target.nextElementSibling?.remove();
        const span = document.createElement('span');
        span.className = 'form-text';
        span.textContent = `Valor formatado: ¥${formattedValue}`;
        e.target.parentNode.appendChild(span);
    }
});

// Atualizar o total dos custos quando qualquer campo de custo for alterado
const custoInputs = document.querySelectorAll('.custo-input');
const totalCustosInput = document.getElementById('total_custos');

function updateTotalCustos() {
    let total = 0;
    custoInputs.forEach(input => {
        const value = Number(input.value) || 0;
        if (input.value === '') {
            input.value = '0';
        }
        total += value;
    });
    totalCustosInput.value = formatNumber(total);
}

custoInputs.forEach(input => {
    input.addEventListener('input', function(e) {
        if (e.target.value < 0) e.target.value = 0;
        updateTotalCustos();
    });
});

// Definir a data atual como valor padrão para o campo de data de entrada
document.getElementById('data_entrada').valueAsDate = new Date();

document.getElementById('stock').addEventListener('input', function(e) {
    if (e.target.value < 0) e.target.value = 0;
});
</script>
{% endblock %}