{% extends "base.html" %}
{% block title %}Editar Produto{% endblock %}
{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Editar Produto</h4>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        {{ form.csrf_token }}
                        <div class="mb-3">
                            <label for="name" class="form-label">Nome do Produto</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ product.name }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Descrição</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ product.description }}</textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="data_entrada" class="form-label">Data de Entrada</label>
                                <input type="date" class="form-control" id="data_entrada" name="data_entrada" value="{{ product.data_entrada.strftime('%Y-%m-%d') if product.data_entrada else '' }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="stock" class="form-label">Quantidade em Estoque</label>
                                <input type="number" class="form-control" id="stock" name="stock" min="0" value="{{ product.stock }}" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="category" class="form-label">Categoria</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="">Selecione uma categoria...</option>
                                    {% for cat in form.category.query_factory() %}
                                        <option value="{{ cat.id }}" {% if product.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="price" class="form-label">Preço</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" value="{{ product.price }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="is_active" class="form-label">Status do Produto</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if product.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="is_active">Ativo</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="custo1" class="form-label">Custo 1</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control custo-input" id="custo1" name="custo1" step="0.01" min="0" value="{{ product.custo1 }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="custo2" class="form-label">Custo 2</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control custo-input" id="custo2" name="custo2" step="0.01" min="0" value="{{ product.custo2 }}">
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="custo3" class="form-label">Custo 3</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control custo-input" id="custo3" name="custo3" step="0.01" min="0" value="{{ product.custo3 }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="custo4" class="form-label">Custo 4</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control custo-input" id="custo4" name="custo4" step="0.01" min="0" value="{{ product.custo4 }}">
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="custo5" class="form-label">Custo 5</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control custo-input" id="custo5" name="custo5" step="0.01" min="0" value="{{ product.custo5 }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="total_custos" class="form-label">Total dos Custos</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="text" class="form-control" id="total_custos" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="images" class="form-label">Imagens do Produto</label>
                            <style>
                            .image-scroll-container {
                                height: 200px;
                                overflow-x: auto;
                                white-space: nowrap;
                                scrollbar-width: thin;
                                scrollbar-color: #6c757d #f8f9fa;
                                margin-bottom: 15px;
                            }
                            .image-scroll-container::-webkit-scrollbar {
                                height: 8px;
                            }
                            .image-scroll-container::-webkit-scrollbar-track {
                                background: #f8f9fa;
                                border-radius: 4px;
                            }
                            .image-scroll-container::-webkit-scrollbar-thumb {
                                background-color: #6c757d;
                                border-radius: 4px;
                            }
                            .image-scroll-container img {
                                transition: transform 0.2s;
                                margin-right: 4px;
                            }
                            .image-scroll-container img:hover {
                                transform: scale(1.05);
                            }
                            .image-container {
                                display: inline-block;
                                position: relative;
                            }
                            .delete-image {
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                background-color: rgba(255, 0, 0, 0.7);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 24px;
                                height: 24px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 14px;
                            }
                            .delete-image:hover {
                                background-color: rgba(255, 0, 0, 0.9);
                            }
                            .dropzone-container {
                                border: 2px dashed #ccc;
                                border-radius: 4px;
                                padding: 20px;
                                text-align: center;
                                background-color: #f8f9fa;
                                transition: all 0.3s ease;
                            }
                            .dropzone-container.dragover {
                                background-color: #e9ecef;
                                border-color: #0d6efd;
                            }
                            .dropzone-area {
                                cursor: pointer;
                            }
                            .image-preview-container {
                                display: flex;
                                flex-wrap: wrap;
                                gap: 10px;
                                margin-top: 15px;
                            }
                            .image-preview {
                                position: relative;
                                width: 150px;
                                height: 150px;
                            }
                            .image-preview img {
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                                border-radius: 4px;
                            }
                            .image-preview .remove-image {
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                background-color: rgba(255, 0, 0, 0.7);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 24px;
                                height: 24px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                            .image-preview .remove-image:hover {
                                background-color: rgba(255, 0, 0, 0.9);
                            }
                            </style>
                            {% if product.images %}
                            <div class="image-scroll-container">
                                {% for image in product.images %}
                                <div class="image-container">
                                    <img src="{{ url_for('products.get_product_image', image_id=image.id) }}" 
                                         alt="{{ product.name }}" 
                                         style="height: 200px; width: auto; object-fit: cover;">
                                    <button type="button" class="delete-image" onclick="deleteImage('{{ image.id }}')">&times;</button>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="dropzone-container" id="dropzone">
                                <div class="dropzone-area">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                    <p>Arraste e solte as imagens aqui ou clique para selecionar</p>
                                    <input type="file" class="form-control d-none" name="images[]" id="fileInput" accept="image/*" multiple>
                                </div>
                                <div id="preview-container" class="image-preview-container"></div>
                            </div>
                            <div class="form-text">Formatos aceitos: PNG, JPG, JPEG, GIF. Selecione até 5 imagens.</div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                            <a href="{{ url_for('products.list_products') }}" class="btn btn-outline-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const previewContainer = document.getElementById('preview-container');
let files = [];

dropzone.addEventListener('click', () => fileInput.click());

dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('dragover');
});

dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('dragover');
});

dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    const newFiles = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
    handleFiles(newFiles);
});

fileInput.addEventListener('change', (e) => {
    const newFiles = Array.from(e.target.files);
    handleFiles(newFiles);
});

function handleFiles(newFiles) {
    const currentImageCount = document.querySelectorAll('.image-container').length;
    if (currentImageCount + files.length + newFiles.length > 5) {
        alert('Você pode ter no máximo 5 imagens.');
        return;
    }

    newFiles.forEach(file => {
        if (!file.type.startsWith('image/')) {
            alert('Por favor, selecione apenas arquivos de imagem.');
            return;
        }

        files.push(file);
        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            preview.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button type="button" class="remove-image" data-filename="${file.name}">&times;</button>
            `;
            previewContainer.appendChild(preview);

            preview.querySelector('.remove-image').addEventListener('click', function() {
                const filename = this.dataset.filename;
                files = files.filter(f => f.name !== filename);
                preview.remove();
                updateFileInput();
            });
        };
        reader.readAsDataURL(file);
    });

    updateFileInput();
}

function updateFileInput() {
    const dataTransfer = new DataTransfer();
    files.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;
}

function formatNumber(number) {
    // Arredonda para 0 casas decimais
    const roundedValue = Math.round(number);
    return new Intl.NumberFormat('ja-JP', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(roundedValue);
}

const priceInput = document.getElementById('price');
priceInput.addEventListener('input', function(e) {
    if (e.target.value < 0) e.target.value = 0;
    const value = e.target.value;
    if (value) {
        const formattedValue = formatNumber(value);
        e.target.nextElementSibling?.remove();
        const span = document.createElement('span');
        span.className = 'form-text';
        span.textContent = `Valor formatado: ¥${formattedValue}`;
        e.target.parentNode.appendChild(span);
    }
});

const custoInputs = document.querySelectorAll('.custo-input');
const totalCustosInput = document.getElementById('total_custos');

function updateTotalCustos() {
    let total = 0;
    custoInputs.forEach(input => {
        total += Number(input.value) || 0;
    });
    totalCustosInput.value = formatNumber(total);
}

custoInputs.forEach(input => {
    input.addEventListener('input', function(e) {
        if (e.target.value < 0) e.target.value = 0;
        updateTotalCustos();
    });
});

document.getElementById('stock').addEventListener('input', function(e) {
    if (e.target.value < 0) e.target.value = 0;
});

// Calcular o total inicial dos custos
updateTotalCustos();

function deleteImage(imageId) {
    if (confirm('Tem certeza que deseja excluir esta imagem?')) {
        fetch(`/products/delete_image/${imageId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name=csrf_token]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const imageContainer = document.querySelector(`button[onclick="deleteImage('${imageId}')"]`).parentNode;
                imageContainer.remove();
            } else {
                alert('Erro ao excluir a imagem.');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir a imagem.');
        });
    }
}
</script>
{% endblock %}